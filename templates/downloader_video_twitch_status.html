{% extends "base.html" %}
{% block content %}

<div>
  {{ macros.m_row_start('0') }}
  {{ macros.m_row_end() }}
  {{ macros.m_hr_head_top() }}
  {{ macros.m_row_start('0') }}
  {{ macros.m_col(2,  macros.m_strong('Streamer')) }}
  {{ macros.m_col(2,  macros.m_strong('DownloadStartedTime')) }}
  {{ macros.m_col(2,  macros.m_strong('LocalUptime')) }}
  {{ macros.m_col(2,  macros.m_strong('Title')) }}
  {{ macros.m_col(2,  macros.m_strong('Category')) }}
  {{ macros.m_col(2,  macros.m_strong('Detail')) }}
  {{ macros.m_row_end() }}
  {{ macros.m_hr_head_bottom() }}
  <div id="status_list_div"></div>
</div> <!--전체-->

<script type="text/javascript">
var package_name = "{{arg['package_name'] }}";
var sub = "{{arg['sub'] }}";
var current_data = null;
let streamlink_process_status = {}
const socket = io.connect(window.location.protocol + "//" + document.domain + ":" + location.port + "/" + package_name + '/' + sub);

$(document).ready(function(){
});

socket.on('start', function(data){
  on_start();
});

socket.on('status', function(data){
  on_status(data);
});

function on_start() {
  $.ajax({
    url: `/${package_name}/ajax/${sub}/entity_list`,
    type: "POST", 
    cache: false,
    data: {},
    dataType: "json",
    success: function (data) {
      streamlink_process_status = data;
      render_list(data)
      // for(let id in data)
      // {
      //   set_uptime(id);
      //   setInterval(()=>{
      //     set_uptime(id)
      //   }, 1000);
      // }
      // make_download_list(data)
    }
  });
}

function set_uptime(streamer_id)
{
  let timestamp = document.getElementById(`${streamer_id}_started_timestamp`).getAttribute('value');

  // 일부러 === 안씀
  if(timestamp == 0)
  {
    return;
  }

  let timeDifference = new Date() - timestamp
  let daysDifference = Math.floor(timeDifference/1000/60/60/24);
  timeDifference -= daysDifference*1000*60*60*24
  let hoursDifference = Math.floor(timeDifference/1000/60/60);
  timeDifference -= hoursDifference*1000*60*60
  let minutesDifference = Math.floor(timeDifference/1000/60);
  timeDifference -= minutesDifference*1000*60
  let secondsDifference = Math.floor(timeDifference/1000);
  let uptimeString = `${daysDifference>0 ? daysDifference+'d ' : ''}`;
  uptimeString += `${hoursDifference>0 ? hoursDifference+'h ' : ''}`;
  uptimeString += `${minutesDifference>0 ? minutesDifference+'m ' : ''}`;
  uptimeString += `${secondsDifference}s`;

  document.getElementById(`${streamer_id}_uptime`).innerText = uptimeString;
}

function get_timestring(date)
{
  let month = date.getMonth()+1 < 10 ? `0${date.getMonth()+1}` : date.getMonth()+1;
  let day = date.getDate() < 10 ? `0${date.getDate()}` : date.getDate();
  let hour = date.getHours() < 10 ? `0${date.getHours()}` : date.getHours();
  let minute = date.getMinutes() < 10 ? `0${date.getMinutes()}` : date.getMinutes();
  return `${day}/${month} ${hour}:${minute}`;
}

function render_list(streamlink_process_status)
{
  str = '';
  for (let streamer_id in streamlink_process_status)
  {
    g_data = streamlink_process_status;

    let timestamp = streamlink_process_status[streamer_id].started_timestamp;
    let dateString = `<div id=${streamer_id}_started_timestamp value=${timestamp}>Not Running</div>`;
    let uptimeString = `<div id=${streamer_id}_uptime>Not Running</div>`;

    if(timestamp !== 0)
    {
      let date = new Date(timestamp)
      dateString = `<div id=${streamer_id}_started_timestamp value=${timestamp}>${get_timestring(date)}</div>`
    }

    let tite = `<div></div>`;
    let category = `<div></div>`;

    str += m_row_start();
    str += m_col(2, streamer_id);
    str += m_col(2, dateString);
    str += m_col(2, uptimeString),
    str += m_col(2, streamlink_process_status[streamer_id].title);
    str += m_col(2, streamlink_process_status[streamer_id].category);
    let detail_button = m_button('detail_btn', '자세히', [{
      'key':'id', 
      'value': streamer_id,
    }]);
    detail_button = m_button_group(detail_button)
    str += m_col(2, detail_button)
    str += m_row_end()
    if (streamer_id != streamlink_process_status[streamlink_process_status.length - 1]) str += m_hr(0);
  }
  document.getElementById("status_list_div").innerHTML = str;
}


function on_status(data) {
  streamlink_process_status = data;

}


/**
 * 이거를 첫 로딩했던 데이터만 가져오는게 나으려나
 * 소켓통신으로 실시간으로 받아오는게 나으려나
 * 
 * logic_twitch.py에서 self.streamlink_process_status가 변하면
 * 소켓으로 데이터 보내주는게 제일 나을거같은데
 * 
 * 리액트면 바로 했다 ㅇㅈ?
 * flask에 react 연동 가능하나
 */
$("body").on('click', '#detail_btn', function(e){
  e.preventDefault();
  let streamer_id = $(this).data('id')
  document.getElementById("confirm_title").innerHTML = streamer_id;
  document.getElementById('confirm_body').innerHTML = JSON.stringify(streamlink_process_status[streamer_id]);
  $("#confirm_modal").modal();
  return;

  // send_data = {'command':'cancel', 'entity_id':entity_id}
  // queue_command(send_data)
});

function queue_command(data) {
  $.ajax({
    url: '/' + package_name + '/ajax/' + sub + '/queue_command',
    type: "POST", 
    cache: false,
    data: data,
    dataType: "json",
    success: function (ret) {
      if (ret.ret == 'notify') {
        $.notify('<strong>'+ ret.log +'</strong>', {type: 'warning'});
      }
      on_start();
    }
  });
}

</script>    
{% endblock %}